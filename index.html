<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Matrix Чат — КП 2-9 (Адмінування)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
    
    <div x-data="додатокЧату()" class="bg-white shadow-2xl flex w-full h-screen overflow-hidden">
        
        <template x-if="!токенДоступу">
            <div class="m-auto w-full max-w-md p-8 bg-white rounded-2xl shadow-xl border border-slate-200">
                <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Вхід у Matrix</h2>
                <input x-model="логін" placeholder="Ім'я користувача" class="border p-3 w-full mb-3 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none" />
                <input x-model="пароль" type="password" placeholder="Пароль" class="border p-3 w-full mb-6 rounded-xl focus:ring-2 focus:ring-indigo-400 outline-none" />
                <button @click="увійти()" class="bg-indigo-600 text-white p-3 w-full rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">Увійти</button>
                <p x-text="помилка" class="text-red-500 mt-4 text-center text-sm"></p>
            </div>
        </template>

        <template x-if="токенДоступу">
            <div class="flex w-full h-full">
                
                <div class="w-72 bg-slate-900 text-white p-4 flex flex-col">
                    <h3 class="font-bold text-indigo-400 uppercase text-xs tracking-widest mb-4 border-b border-slate-700 pb-2">Кімнати</h3>
                    
                    <div class="flex-grow overflow-y-auto space-y-1">
                        <template x-for="кімната in списокКімнат" :key="кімната.id">
                            <div @click="змінитиКімнату(кімната.id)" 
                                 :class="IDкімнати === кімната.id ? 'bg-indigo-600' : 'hover:bg-slate-800'"
                                 class="p-2 rounded-lg cursor-pointer transition flex items-center justify-between group">
                                <span class="truncate text-sm" x-text="кімната.назва"></span>
                                <button @click.stop="покинутиКімнату(кімната.id)" 
                                        class="text-red-400 hover:text-red-200 text-xs font-bold px-2 py-1 opacity-0 group-hover:opacity-100 transition">
                                    × Видалити
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="flex-grow flex flex-col bg-slate-50">
                    <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
                        <h2 class="font-bold text-slate-800" x-text="IDкімнати ? 'Чат активний' : 'Оберіть чат'"></h2>
                        <div class="flex gap-2">
                            <input x-model="користувачДляЗапрошення" placeholder="@user:matrix.org" class="border p-2 text-xs rounded-lg w-40" />
                            <button @click="запросити()" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-emerald-700">Invite</button>
                        </div>
                    </div>

                    <div class="flex-grow p-6 overflow-y-auto space-y-4">
                        <template x-for="повідомлення in списокПовідомлень" :key="повідомлення.event_id">
                            <div :class="повідомлення.sender === мійID ? 'flex justify-end' : 'flex justify-start'">
                                <div :class="повідомлення.sender === мійID ? 'bg-indigo-600 text-white' : 'bg-white border text-slate-800'"
                                     class="p-3 rounded-2xl max-w-sm text-sm shadow-sm">
                                    <p x-text="повідомлення.content.body"></p>
                                    <span class="text-[9px] opacity-50 block mt-1" x-text="повідомлення.sender.split(':')[0]"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="p-4 bg-white border-t flex gap-2">
                        <input @keyup.enter="відправитиПовідомлення()" x-model="текстНовогоПовідомлення" placeholder="Повідомлення..." class="border p-3 flex-grow rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" />
                        <button @click="відправитиПовідомлення()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition">Надіслати</button>
                    </div>
                </div>

                <div class="w-64 bg-white border-l p-4 overflow-y-auto">
                    <h3 class="font-bold mb-4 text-slate-700 text-xs border-b pb-2 uppercase tracking-tighter">Учасники кімнати</h3>
                    <div class="space-y-2">
                        <template x-for="учасник in учасникиКімнати" :key="учасник.userId">
                            <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg group">
                                <div class="flex items-center gap-2 truncate">
                                    <div class="w-6 h-6 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-[10px] font-bold" x-text="учасник.displayName[0].toUpperCase()"></div>
                                    <span class="text-xs font-medium text-slate-800 truncate" x-text="учасник.displayName"></span>
                                </div>
                                <button @click.stop="вигнатиКористувача(учасник.userId)" 
                                        class="text-red-500 hover:text-red-700 font-black text-lg px-1 leading-none opacity-0 group-hover:opacity-100 transition"
                                        title="Викинути з кімнати">
                                    ×
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
    function додатокЧату() {
        return {
            логін: '', пароль: '', токенДоступу: '', мійID: '', помилка: '',
            списокКімнат: [], списокПовідомлень: [], текстНовогоПовідомлення: '', 
            IDкімнати: '', користувачДляЗапрошення: '', учасникиКімнати: [],

            async увійти() {
                try {
                    const res = await fetch('https://matrix.org/_matrix/client/r0/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'm.login.password', user: this.логін, password: this.пароль })
                    });
                    const дані = await res.json();
                    if (дані.access_token) {
                        this.токенДоступу = дані.access_token;
                        this.мійID = дані.user_id;
                        this.отриматиКімнати();
                    } else { this.помилка = 'Помилка входу'; }
                } catch (e) { this.помилка = 'Мережева помилка'; }
            },

            async отриматиКімнати() {
                const res = await fetch(`https://matrix.org/_matrix/client/r0/joined_rooms?access_token=${this.токенДоступу}`);
                const дані = await res.json();
                this.списокКімнат = дані.joined_rooms.map(id => ({ id: id, назва: 'Кімната ' + id.split(':')[0].substring(1, 8) }));
            },

            async змінитиКімнату(ід) {
                this.IDкімнати = ід;
                this.списокПовідомлень = [];
                this.отриматиПовідомлення();
                this.отриматиУчасників();
            },

            async отриматиПовідомлення() {
                if (!this.IDкімнати) return;
                const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.IDкімнати}/messages?limit=30&dir=b&access_token=${this.токенДоступу}`);
                const дані = await res.json();
                this.списокПовідомлень = дані.chunk.reverse();
            },

            async отриматиУчасників() {
                if (!this.IDкімнати) return;
                const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.IDкімнати}/joined_members?access_token=${this.токенДоступу}`);
                const дані = await res.json();
                this.учасникиКімнати = Object.entries(дані.joined || {}).map(([id, info]) => ({
                    userId: id,
                    displayName: info.display_name || id.split(':')[0].substring(1)
                }));
            },

            async покинутиКімнату(roomId) {
                if (!confirm('Покинути цю кімнату?')) return;
                try {
                    const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(roomId)}/leave`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.токенДоступу}` }
                    });
                    if (res.ok) {
                        this.списокКімнат = this.списокКімнат.filter(r => r.id !== roomId);
                        if (this.IDкімнати === roomId) this.IDкімнати = '';
                        alert('Кімнату видалено зі списку');
                        this.отриматиКімнати();
                    }
                } catch (e) { alert('Помилка при виході'); }
            },

            async вигнатиКористувача(userId) {
                if (!confirm(`Вигнати ${userId}?`)) return;
                try {
                    const res = await fetch(`https://matrix.org/_matrix/client/r0/rooms/${encodeURIComponent(this.IDкімнати)}/kick`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.токенДоступу}` 
                        },
                        body: JSON.stringify({ user_id: userId })
                    });
                    if (res.ok) {
                        this.учасникиКімнати = this.учасникиКімнати.filter(m => m.userId !== userId);
                        alert('Користувача вигнано');
                        this.отриматиУчасників();
                    } else { alert('Немає прав для цієї дії'); }
                } catch (e) { alert('Помилка при видаленні користувача'); }
            },

            async відправитиПовідомлення() {
                if (!this.текстНовогоПовідомлення || !this.IDкімнати) return;
                await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.IDкімнати}/send/m.room.message?access_token=${this.токенДоступу}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ msgtype: 'm.text', body: this.текстНовогоПовідомлення })
                });
                this.текстНовогоПовідомлення = '';
                this.отриматиПовідомлення();
            },

            async запросити() {
                if (!this.користувачДляЗапрошення || !this.IDкімнати) return;
                await fetch(`https://matrix.org/_matrix/client/r0/rooms/${this.IDкімнати}/invite?access_token=${this.токенДоступу}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: this.користувачДляЗапрошення })
                });
                alert('Запрошено!');
                this.користувачДляЗапрошення = '';
            }
        }
    }
    </script>
</body>
</html>